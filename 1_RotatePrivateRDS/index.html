



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="A hands-on workshop to learn about using Secrets Manager.">
      
      
        <link rel="canonical" href="https://secrets-manager.awssecworkshops.com/1_RotatePrivateRDS/">
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Secrets Manager Workshop</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#aws-secrets-manager-workshop" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <!--
  Copyright (c) 2016-2018 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->
<header class="md-header" data-md-component="header">

    <!-- Top-level navigation -->
    <nav class="md-header-nav md-grid">
      <div class="md-flex">
  
        <!-- Link to home -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://aws.amazon.com/"
              title="Amazon Web Services"
              class="md-header-nav__button md-logo">
            
              <img src="../assets/images/aws_smile_logo.png" width="40" height="24" />
            
          </a>
        </div>
  
        <!-- Button to toggle drawer -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <label class="md-icon md-icon--menu md-header-nav__button"
              for="__drawer"></label>
        </div>
  
        <!-- Header title -->
        <div class="md-flex__cell md-flex__cell--stretch">
          <div class="md-flex__ellipsis md-header-nav__title"
              data-md-component="title">
            
              
                <span class="md-header-nav__topic">
                  Secrets Manager Workshop
                </span>
                <span class="md-header-nav__topic">
                  Home
                </span>
              
            
          </div>
        </div>
        
        
        <!-- Button to open search dialogue -->
        <!--
        <div class="md-flex__cell md-flex__cell--shrink">
          
            
              <label class="md-icon md-icon--search md-header-nav__button"
                  for="__search"></label>
  
              
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
            
          
        </div>

         -->
         
         <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-flex__ellipsis md-header-nav__lang">
                <div>
                    <button onclick="window.location.href = 'https://awssecworkshops.com/';" class="md-lang-dropbtn fa fa-home"></button>
                </div>
            </div>
        </div>
  
        <!-- Repository containing source -->
        
          <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-header-nav__source">
              


  

<a href="https://github.com/aws-samples/aws-secretsmgr-workshop/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aws-samples/aws-secretsmgr-workshop
  </div>
</a>
            </div>
          </div>
        
      </div>
    </nav>
  </header>
    
    <div class="md-container">
      
        
      
      
        

<nav class="md-tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." title="Overview" class="md-tabs__link md-tabs__link--active">
        Overview
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../RDSFargateRound/" title="RDS and Fargate" class="md-tabs__link">
          RDS and Fargate
        </a>
      
    </li>
  

      
        
      
        
      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <!--
  Copyright (c) 2016-2019 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Main navigation -->
<nav class="md-nav md-nav--primary" data-md-level="0">

  <!-- Site title -->
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://secrets-manager.awssecworkshops.com/"
        title="Secrets Manager Workshop" class="md-nav__button md-logo">
      
        <img src="../assets/images/aws_smile_logo.png" width="48" height="48" />
      
    </a>
    Secrets Manager Workshop
  </label>

  <!-- Repository containing source -->
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/aws-samples/aws-secretsmgr-workshop/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aws-samples/aws-secretsmgr-workshop
  </div>
</a>
    </div>
  

  <!-- Render item list -->
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      RDS and Fargate
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        RDS and Fargate
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../RDSFargateRound/" title="Scenario" class="md-nav__link">
      Scenario
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../RDSFargateRound/getting-started/" title="Getting started" class="md-nav__link">
      Getting started
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../RDSFargateRound/build/" title="Build phase" class="md-nav__link">
      Build phase
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../RDSFargateRound/RDS/" title="RDS phase" class="md-nav__link">
      RDS phase
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../RDSFargateRound/Fargate/" title="Fargate phase" class="md-nav__link">
      Fargate phase
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../RDSFargateRound/cleanup/" title="Clean up phase" class="md-nav__link">
      Clean up phase
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../contribute/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://github.com/aws-samples/aws-secretsmgr-workshop/blob/master/LICENSE" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/aws-secretsmgr-workshop/edit/master/docs/1_RotatePrivateRDS/README.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <!--                                                                                       -->

<!-- Copyright 2018 Amazon.com, Inc. or its affiliates. All Rights Reserved.               -->

<!--                                                                                       -->

<!-- Permission is hereby granted, free of charge, to any person obtaining a copy of this  -->

<!-- software and associated documentation files (the "Software"), to deal in the Software -->

<!-- without restriction, including without limitation the rights to use, copy, modify,    -->

<!-- merge, publish, distribute, sublicense, and/or sell copies of the Software, and to    -->

<!-- permit persons to whom the Software is furnished to do so.                            -->

<!--                                                                                       -->

<!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,   -->

<!-- INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A         -->

<!-- PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT    -->

<!-- HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION     -->

<!-- OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE        -->

<!-- SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                                -->

<!--                                                                                       -->

<h1 id="aws-secrets-manager-workshop"><strong><em>AWS Secrets Manager Workshop</em></strong></h1>
<h1 id="module-1-rotating-the-secret-for-a-private-amazon-rds-database">Module 1 - Rotating the secret for a private Amazon RDS database</h1>
<h3 id="introduction">Introduction</h3>
<p>This module shows how to use AWS Secrets Manager for rotating the password for a private Amazon RDS database.</p>
<h3 id="architecture-overview">Architecture Overview</h3>
<p>Here's a diagram of what we are going to build.</p>
<p><img alt="Architecture diagram" src="img/1_RotatePrivateRDSArch.png" /></p>
<p>This environment consists of a VPC in the us-east-1 region with two subnets.  The subnets containts an Amazon EC2 bastion host running Amazon Linux 2 used for running AWS CLI commands and a private, not publicly-accessible, Amazon RDS MySQL database instance.  The subnets are chosen based on the presence of a VPC endpoint for AWS Secrets Manager.  When we initiate a rotation of the RDS database, the AWS Lambda function that Secrets Manager uses will reach out to the Amazon RDS database to perform the rotation.</p>
<h3 id="security-note">Security Note</h3>
<table>
<thead>
<tr>
<th><strong>Security Note</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
<tr>
<td><strong><em>For the sake of simplicity, this tutorial uses jq to parse the secret value into environment variables to allow for easy command line manipulation. This is NOT a security best practice for a production environment. In a production environment, we recommend that you don't store passwords in environment variables.</em></strong></td>
</tr>
</tbody>
</table>
<h3 id="prerequisites">Prerequisites</h3>
<p>In order to complete this workshop you'll need the following:
<br />
* an AWS Account with administrator access to services used in the module including AWS Secrets Manager, AWS CloudFormation, Amazon EC2, Amazon RDS, and Amazon VPC</p>
<h3 id="charges">Charges</h3>
<p>You will incur charges for the services used in these modules.  The pricing for each service is available on that service's pricing page.</p>
<h3 id="1-choose-a-region">1. Choose a region</h3>
<p>You need to choose a region that offers AWS Secrets Manager and Amazon RDS.  For information about service availability, check the <a href="https://aws.amazon.com/about-aws/global-infrastructure/regional-product-services/">region table</a>.</p>
<p><strong>Tip:</strong> The AWS region name is always listed in the upper-right corner of the AWS Management Console, in the navigation bar.</p>
<p>Make a note of the AWS <em>region name</em>, for example, <em>US East (N. Virginia)</em>. For more information about regions, see: <a href="http://docs.aws.amazon.com/general/latest/gr/rande.html">AWS Regions and Endpoints</a>.</p>
<h3 id="2-complete-initial-environment-configuration">2. Complete initial environment configuration</h3>
<p><details open>
<summary><strong>(expand for details)</strong></summary>
<br /></p>
<p>In this section, you will use AWS CloudFormation to build the environment shown in the diagram above.</p>
<p><strong><em>Complete all the steps below unless they are marked "optional."</em></strong></p>
<ul>
<li>
<p><strong>2.1.</strong> Download the <a href="https://github.com/aws-samples/aws-secretsmgr-workshop/blob/master/1_RotatePrivateRDS/1_RotatePrivateRDS.yaml">AWS Cloudformation template</a> and save it to your workstation.</p>
</li>
<li>
<p><strong>2.2.</strong> In the AWS Management Console, Under Management Tools, Select <strong>CloudFormation</strong>.</p>
</li>
<li>
<p><strong>2.3.</strong> Click the <strong>Create stack</strong> button.</p>
</li>
<li>
<p><strong>2.4.</strong> Select the <strong>Upload a template to Amazon S3</strong> radio button.</p>
</li>
<li>
<p><strong>2.5.</strong> Click the <strong>Choose file</strong> button and use the file navigation pop-up to select the CloudFormation template you just downloaded.</p>
</li>
<li>
<p><strong>2.6.</strong> Click the <strong>Next</strong> button.</p>
</li>
</ul>
<p>Enter the values below into Stack name and parameter fields:
<br /></p>
<table>
<thead>
<tr>
<th>Field name</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Stack name</td>
<td>You can choose or just use <strong>smdemo</strong></td>
</tr>
<tr>
<td>Enter the name of the database</td>
<td>Accept the default value of <strong>smdemo</strong></td>
</tr>
<tr>
<td>Enter the TCP port for the database endpoint</td>
<td>Accept the default value of <strong>3306</strong></td>
</tr>
<tr>
<td>Enter a prefix for the Name tag</td>
<td>Accept the default value of <strong>smdemo</strong></td>
</tr>
<tr>
<td>Enter the value for the Project tag</td>
<td>Accept the default value of <strong>smproj</strong></td>
</tr>
<tr>
<td>Enter the SSM AMI Id Parameter</td>
<td>Accept the default value - Do not change!</td>
</tr>
</tbody>
</table>
<p><br /></p>
<ul>
<li>
<p><strong>2.7.</strong> Click the <strong>Next</strong> button.</p>
</li>
<li>
<p><strong>2.8.</strong> On the Options page, click the <strong>Next</strong> button.</p>
</li>
<li>
<p><strong>2.9.</strong> On the Review page, check the acknowledgement box and click the <strong>Create</strong> button.  AWS CloudFormation will the build the resource stack.  This may take 15-20 minutes to complete.  Wait until the status of the stack changes to "CREATE_COMPLETE."  You can periodically refresh the page to update the status.   If the stack creation fails, look at the bottom of the page and select the Events tab.   You should be able to see the reason for the failure in the Status Reason column.  A common reason for a failure is not having specified some of the parameters when creating the stack.</p>
</li>
<li>
<p><strong>2.10.</strong> Let's take a look at the Output section of the CloudFormation stack.</p>
</li>
</ul>
<p><img alt="CloudFormation Outputs" src="img/1_RotatePrivateRDSCFOut.png" /></p>
<p>The outputs values include the RDS master username and password, both of which are set to random alphanumeric strings for added security. You will store the DBUser and DBPassword values as a secret in Secrets Manager.  You will se the DBEndpoint value to help you select the correct database in Secrets Manager.  Another output value is the IP address of the bastion host.  You will need this IP address to set up a connection to the bastion host later in this module.  Keep this window open.
</details></p>
<h3 id="3-store-the-secret-value-in-aws-secrets-manager">3. Store the secret value in AWS Secrets Manager</h3>
<details open>
<summary><strong>(expand for details)</strong></summary>
<br />

In this section, you will store the RDS database credentials in AWS Secrets Manager.  You will use the DBUser and DBPassword values that were output from the AWS CloudFormation.

- __3.1.__ Open the [AWS Secrets Manager Console](https://console.aws.amazon.com/secretsmanager/home) in a new tab or window.

- __3.2.__ Click **Store a new secret**.

- __3.3.__ Select the **Credentials for RDS database** radio button.

- __3.4.__ Copy the values for the DBUser and DBPassword CloudFormation output values that you got from item 2.10 above into the **User name** and **Password** fields respectively.   Scroll down to the bottom of the page and you will see a list of your RDS instances.  Using the DBendpoint output value that you got from item 2.10 above, select the RDS instance.

![AWS Secrets Manager store secret part 1](img/1_RotatePrivateRDSSMStore1.png)

- __3.5.__ Click **Next**.

- __3.6.__ Enter a name for the secret.  You can pick a name or just use **smdemo** as shown below.  Note that this must bot be the name of a secret that is pending deletion.

![AWS Secrets Manager store secret part 2](img/1_RotatePrivateRDSSMStore2.png)

- __3.7.__ Click **Next**.

- __3.8__ Select **Disable automatic rotation** and then click **Next**.   We will enable rotation later in this module.

![AWS Secrets Manager store secret part 3](img/1_RotatePrivateRDSSMStore3.png)

- __3.9.__ Click **Store**.

You have now stored your secret value as shown below.

![AWS Secrets Manager store secret part 4](img/1_RotatePrivateRDSSMStore4.png)

</details>

<h3 id="4-connect-to-the-amazon-ec2-bastion-host-and-access-the-rds-database">4. Connect to the Amazon EC2 bastion host and access the RDS database</h3>
<details open>
<summary><strong>(expand for details)</strong></summary>
<br />

In this section, you will connect to the bastion host so you can run scripts that the CloudFormation template has created on the instance.

___Complete all the steps below unless they are marked "optional."___

- __4.1.__ Connect to the bastion host using AWS Systems Manager Session Manager.

- __4.2.__ After you login, use the **sudo su ec2-user** command since the ec2-user id is the owner of all the scripts.

- __4.3.__ Change to the home directory of the ec2-user id by entering the **cd** command without any arguments.

- __4.4.__ Use the **ls** command to list the contents of the home directory.  You will see two shell scripts.

  * mysql.oldway.sh - This shell script connects to the database the "old" way, using a hard-coded password.

  * mysql.newway.sh - This shell script connects to the database the "new" way, using AWS Secrets Manager.

- __4.5.__ Let's take a look at the file mysql.oldway.sh.  You can use the **cat** command to do this.  In the example below, the values PASSWORD, USER, and ENDPOINT represent the hard-coded database password, username, and host endpoint.


wzxhzdk:0


- __4.6.__ Now let's try this script by running the following commands.  The first command invokes the script.  The subsequent commands select the database, display the table names in the database, query the rows in the table, and exit MySQL.


wzxhzdk:1


You can see an example of the output below.  This shows that you can access the database, the "old" way, with a hard-coded user name and password. You may be wondering why MariaDB appears in the image below.  Amazon Linux 2 includes the MariaDB port of the **mysql** command as an "extras" module.  The **mysql** program is compatible with both MySQL and MariaDB.

![AWS Secrets Manager old way before rotation](img/1_RotatePrivateRDSMSQLoldpre.png)

- __4.7.__ Let's take a look at the file mysql.newway.sh.  You can use the **cat** command to do this.  As mentioned above, for the sake of simplicity, the scripts used in the tutorial use *jq* to parse the secret value into shell variables to allow for easy command line manipulation. This is NOT a security best practice for a production environment. In a production environment, we recommend that you don't store passwords in environment variables, and work with them in plaintext at the command line.


wzxhzdk:2


- __4.8.__ Now let's try this script by running the following commands.  The first command invokes the script.  **Note that you must specify the name of the secret!** The subsequent commands select the database, display the table names in the database, query the rows in the table, and exit MySQL.


wzxhzdk:3


You can see an example of the output below.  This shows that you can access the database, the "new" way, using AWS Secrets Manager.

![AWS Secrets Manager new way before rotation](img/1_RotatePrivateRDSMSQLnewpre.png)
</details>

<h3 id="5-enable-aws-secrets-manager-and-perform-the-first-password-rotation">5. Enable AWS Secrets Manager and perform the first password rotation</h3>
<details open>
<summary><strong>(expand for details)</strong></summary>
<br />

In this section, you will enable the rotation of the secret you created in AWS Secrets Manager.

- __5.1.__ Go to the main screen of the AWS Secrets Manager console.

- __5.2.__ Click on the secret that you previously created.

- __5.3.__ Click **Edit rotation**.

- __5.4.__ Select **Enable automatic rotation**. Choose **30 days** for the rotation interval.  Click **Use this secret** because we will be using the credentials of this secret to access the database and then rotate the same credentials.  Click **Save** to begin the process.

![AWS Secrets Manager rotation part 1](img/1_RotatePrivateRDSRotate1.png)

- __5.5.__ You will see a message telling you that the rotation is beginning and that you should remain on the page until it is complete. AWS Secrets Manager is now using the [AWS Serverless Application Repository](https://aws.amazon.com/serverless/serverlessrepo/) to install an [AWS Lambda rotation](https://aws.amazon.com/lambda/) function on your behalf.  **Do not leave this page until the rotation is complete.**

![AWS Secrets Manager rotation part 2](img/1_RotatePrivateRDSRotate2.png)

A message will appear when the rotation is complete.  **Refresh your browser window to update your any cached fields.**

![AWS Secrets Manager rotation part 3](img/1_RotatePrivateRDSRotate3.png)

- __5.6.__ Click **Retrieve secret value** to see the new password value.

</details>

<h3 id="6-connect-to-the-database-after-rotating-the-password">6. Connect to the database after rotating the password</h3>
<details open>
<summary><strong>(expand for details)</strong></summary>
<br />

Let's try to connect to the database again, both the "old" way with a hard-coded password, the "new" way with AWS Secrets Manager.

- __6.1.__ On the bastion host, repeat step 4.6 with the **mysql.oldway.sh** script.   You should receive an error message (access denied) because the mysql.oldway.sh script has the same hard-coded password.

![AWS Secrets Manager old way after rotation](img/1_RotatePrivateRDSMSQLoldpost.png)

- __6.2.__ Repeat step 4.8 with the **mysql.newway.sh** script.   You should be able to connect to the database just as you did before since this script uses AWS Secrets Manager to fetch the updated credentials.

</details>

<h3 id="7-clean-up">7. Clean up</h3>
<details open>
<summary><strong>(expand for details)</strong></summary>

Now that you have seen how AWS Secrets Manager can rotate the credentials for a private database, please follow these steps to remove the resources you created, including the private database.

- __7.1.__ [Delete the secret you created in Secrets Manager](https://docs.aws.amazon.com/secretsmanager/latest/userguide/manage_delete-restore-secret.html?shortFooter=true).  Note that when you delete a secret, the deletion is scheduled for a minimum of seven days in the future. 

- __7.2.__ When you enabled rotation on your secret, AWS Secrets Manager used AWS CloudFormation to create an AWS Lambda function to do the rotation using the [AWS Serverless Application Repository](https://aws.amazon.com/serverless/serverlessrepo/).  Go to the AWS CloudFormation console and delete this stack.  The name of the stack begins with the following string:

  **aws-serverless-repository-SecretsManagerRDSMySQLRotationSingleUser**

  Look for a stack with this naming convention that was created at about the same time as you enabled rotation.  **Do not proceed to the next step until this stack has been deleted.**

- __7.3.__ [Delete the main CloudFormation stack](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-console-delete-stack.html) that you created in steps 2.1 through 2.9.  The stack deletion process may take several minutes to complete.  If the stack deletion process either pauses or fails, it may be because of an Elastic Network Interface that gets created when rotation is enabled.  If you delete this interface and restart the stack deletion.

</details>

<h3 id="8-conclusion">8. Conclusion</h3>
<p>You have completed this module. Visit the <a href="https://github.com/aws-samples/aws-secretsmgr-workshop">main Secrets Managager workshop site</a> for more workshops as they become available.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2019, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://awssecworkshops.com" class="md-footer-social__link fa fa-home"></a>
    
      <a href="https://aws.amazon.com/security/" class="md-footer-social__link fa fa-shield"></a>
    
      <a href="https://twitter.com/awssecurityinfo?lang=en" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://aws.amazon.com/blogs/security/" class="md-footer-social__link fa fa-rss"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>